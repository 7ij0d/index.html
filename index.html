<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quiz Generator Pro</title>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
    --primary: #c40000;
    --primary-dark: #9d0000;
    --bg: #0b0b0b;
    --card-bg: #151515;
    --text: #ffffff;
    --text-secondary: #aaaaaa;
    --border: #333333;
    --success: #00a86b;
    --warning: #ff9800;
}

* {
    box-sizing: border-box;
}

body {
    background: var(--bg);
    margin: 0;
    padding: 20px;
    color: var(--text);
    font-family: 'Segoe UI', Arial, sans-serif;
    line-height: 1.6;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
}

/* Header */
.header {
    background: linear-gradient(135deg, #1a1a1a, #0d0d0d);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.header h1 {
    margin: 0;
    color: var(--primary);
    font-size: 32px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.header p {
    color: var(--text-secondary);
    margin: 10px 0 0 0;
}

/* Stats Cards */
.stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.stat-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    transition: transform 0.3s, box-shadow 0.3s;
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.4);
}

.stat-number {
    font-size: 24px;
    font-weight: bold;
    color: var(--primary);
}

.stat-label {
    font-size: 14px;
    color: var(--text-secondary);
    margin-top: 5px;
}

/* Input Styles */
input, textarea, select {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    background: #1a1a1a;
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 16px;
    transition: border 0.3s;
}

input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(196, 0, 0, 0.2);
}

textarea {
    min-height: 120px;
    resize: vertical;
    font-family: 'Courier New', monospace;
    line-height: 1.5;
}

/* Button Styles */
.btn {
    padding: 12px 20px;
    margin: 8px 5px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
}

.btn-secondary {
    background: #2a2a2a;
    color: white;
}

.btn-secondary:hover {
    background: #3a3a3a;
}

.btn-success {
    background: var(--success);
    color: white;
}

.btn-warning {
    background: var(--warning);
    color: white;
}

.btn-group {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 20px 0;
}

/* Question Cards */
.question-card {
    background: var(--card-bg);
    border: 2px solid var(--border);
    border-radius: 10px;
    padding: 20px;
    margin: 15px 0;
    position: relative;
    transition: all 0.3s;
}

.question-card:hover {
    border-color: var(--primary);
}

.question-card.selected {
    border-color: var(--primary);
    background: rgba(196, 0, 0, 0.05);
}

.question-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
}

.question-number {
    font-size: 18px;
    font-weight: bold;
    color: var(--primary);
}

.question-actions {
    display: flex;
    gap: 8px;
}

.action-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-secondary);
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
}

.action-btn:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

/* Options Grid */
.options-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
    margin: 10px 0;
}

.option-item {
    background: #1a1a1a;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
}

.option-item.correct {
    border-color: var(--success);
    background: rgba(0, 168, 107, 0.1);
}

/* Output Preview */
.output-container {
    background: var(--card-bg);
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 25px;
    margin-top: 30px;
    position: relative;
}

.output-actions {
    position: absolute;
    top: 15px;
    right: 15px;
    display: flex;
    gap: 10px;
}

.preview-header {
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--primary);
}

/* Toast Notifications */
.toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--success);
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    display: none;
    z-index: 1000;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 1001;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 30px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

/* Progress Bar */
.progress-container {
    margin: 20px 0;
}

.progress-bar {
    height: 8px;
    background: #2a2a2a;
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--primary);
    width: 0%;
    transition: width 0.3s;
}

/* Responsive */
@media (max-width: 768px) {
    .container {
        padding: 10px;
    }
    
    .btn-group {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
        justify-content: center;
    }
    
    .options-grid {
        grid-template-columns: 1fr;
    }
}

/* Custom Scrollbar */
::-webkit-scrollbar {
    width: 10px;
}

::-webkit-scrollbar-track {
    background: #1a1a1a;
}

::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--primary-dark);
}

/* Toggle Switch */
.switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 30px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #2a2a2a;
    transition: .4s;
    border-radius: 34px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: var(--primary);
}

input:checked + .slider:before {
    transform: translateX(30px);
}

/* Quick Actions */
.quick-actions {
    background: var(--card-bg);
    border-radius: 10px;
    padding: 15px;
    margin: 20px 0;
}

.quick-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 10px;
    margin-top: 10px;
}
</style>
</head>

<body>
<div class="container">
    <!-- Home Screen -->
    <div id="homeScreen">
        <div class="header">
            <h1><i class="fas fa-graduation-cap"></i> Quiz Generator Pro</h1>
            <p>Create, manage, and export professional quizzes with ease</p>
        </div>
        
        <div class="stats-container" id="homeStats">
            <!-- Stats will be populated by JavaScript -->
        </div>
        
        <div class="btn-group">
            <button class="btn btn-primary" onclick="newQuiz()">
                <i class="fas fa-plus"></i> New Quiz
            </button>
            <button class="btn btn-secondary" onclick="showLoadMenu()">
                <i class="fas fa-folder-open"></i> Load Quiz
            </button>
            <button class="btn btn-secondary" onclick="showTemplates()">
                <i class="fas fa-layer-group"></i> Templates
            </button>
            <button class="btn btn-secondary" onclick="showStats()">
                <i class="fas fa-chart-bar"></i> Statistics
            </button>
        </div>
        
        <div id="loadMenu" style="display:none; margin-top:20px;">
            <h3><i class="fas fa-search"></i> Select Quiz</h3>
            <div class="input-group">
                <input type="text" id="searchQuiz" placeholder="Search quizzes..." onkeyup="filterQuizzes()">
            </div>
            <div style="display:flex; gap:15px; margin:15px 0;">
                <select id="loadSubject" style="flex:1;"></select>
                <select id="loadSheet" style="flex:1;"></select>
            </div>
            <div id="quizList" style="max-height:300px; overflow-y:auto; margin:15px 0;"></div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="loadSelectedQuiz()">
                    <i class="fas fa-external-link-alt"></i> Open Selected
                </button>
                <button class="btn btn-warning" onclick="deleteSelectedQuiz()">
                    <i class="fas fa-trash"></i> Delete Selected
                </button>
                <button class="btn btn-secondary" onclick="exportSelectedQuiz()">
                    <i class="fas fa-download"></i> Export as JSON
                </button>
            </div>
        </div>
        
        <div id="recentQuizzes" style="margin-top:30px; display:none;">
            <h3><i class="fas fa-history"></i> Recent Quizzes</h3>
            <div id="recentList"></div>
        </div>
    </div>
    
    <!-- Main Editor -->
    <div id="mainUI" style="display:none;">
        <!-- Header -->
        <div class="header">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2><i class="fas fa-edit"></i> Quiz Editor</h2>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="goHome()">
                        <i class="fas fa-home"></i> Home
                    </button>
                    <button class="btn btn-secondary" onclick="autoSave()" id="saveStatus">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            </div>
            
            <div class="progress-container">
                <div>Quiz Completion: <span id="completionPercent">0%</span></div>
                <div class="progress-bar">
                    <div class="progress-fill" id="completionBar"></div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
            <h4><i class="fas fa-bolt"></i> Quick Actions</h4>
            <div class="quick-buttons">
                <button class="btn btn-secondary" onclick="duplicateLastQuestion()">
                    <i class="fas fa-copy"></i> Duplicate Last
                </button>
                <button class="btn btn-secondary" onclick="clearAllQuestions()">
                    <i class="fas fa-broom"></i> Clear All
                </button>
                <button class="btn btn-secondary" onclick="randomizeAnswers()">
                    <i class="fas fa-random"></i> Randomize
                </button>
                <button class="btn btn-secondary" onclick="validateQuiz()">
                    <i class="fas fa-check-circle"></i> Validate
                </button>
            </div>
        </div>
        
        <!-- Quiz Metadata -->
        <div class="metadata-grid" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:15px; margin:20px 0;">
            <div>
                <label><i class="fas fa-heading"></i> Sheet Name:</label>
                <input id="sheetName" placeholder="Enter quiz name">
            </div>
            <div>
                <label><i class="fas fa-book"></i> Subject:</label>
                <select id="subjectSelect" onchange="toggleOtherSubject()">
                    <option value="">Select Subject</option>
                    <option>Oral histology</option>
                    <option>Microbiology</option>
                    <option>Removeable prosthodontic</option>
                    <option>Pathology</option>
                    <option>Fixed prosthodontic</option>
                    <option>Conservative</option>
                    <option>Pharmacology</option>
                    <option value="other">Other</option>
                </select>
                <input id="otherSubject" placeholder="Write subject name" style="display:none; margin-top:5px;">
            </div>
            <div>
                <label><i class="fas fa-users"></i> Group:</label>
                <select id="groupSelect" onchange="toggleOtherGroup()">
                    <option value="">Select Group</option>
                    <option>A1-B1</option>
                    <option>C1-D1</option>
                    <option>A2-B2</option>
                    <option>C2-D2</option>
                    <option value="other">Other</option>
                </select>
                <input id="otherGroup" placeholder="Write group name" style="display:none; margin-top:5px;">
            </div>
            <div>
                <label><i class="fas fa-calendar"></i> Date:</label>
                <div style="display:flex; gap:5px;">
                    <select id="year" style="flex:1;">
                        <option>2025</option>
                        <option selected>2026</option>
                        <option>2027</option>
                        <option>2028</option>
                    </select>
                    <select id="month" style="flex:1;">
                        <option value="01">Jan</option><option value="02">Feb</option>
                        <option value="03">Mar</option><option value="04">Apr</option>
                        <option value="05">May</option><option value="06">Jun</option>
                        <option value="07">Jul</option><option value="08">Aug</option>
                        <option value="09">Sep</option><option value="10">Oct</option>
                        <option value="11">Nov</option><option value="12">Dec</option>
                    </select>
                    <select id="day" style="flex:1;"></select>
                </div>
            </div>
        </div>
        
        <!-- Question Generator -->
        <div style="background:var(--card-bg); padding:20px; border-radius:10px; margin:20px 0;">
            <h3><i class="fas fa-question-circle"></i> Questions</h3>
            
            <div style="display:flex; gap:15px; align-items:center; margin:15px 0;">
                <div style="flex:1;">
                    <label>Number of Questions:</label>
                    <select id="questionCount" onchange="createQuestions()" style="width:100%;">
                        <option value="">-- Select Number --</option>
                        <option value="1">1 Question</option>
                        <option value="5">5 Questions</option>
                        <option value="10">10 Questions</option>
                        <option value="15">15 Questions</option>
                        <option value="20">20 Questions</option>
                        <option value="25">25 Questions</option>
                        <option value="30">30 Questions</option>
                        <option value="40">40 Questions</option>
                        <option value="50">50 Questions</option>
                    </select>
                </div>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="btn btn-primary" onclick="addSingleQuestion()">
                        <i class="fas fa-plus"></i> Add One
                    </button>
                    <button class="btn btn-secondary" onclick="importQuestions()">
                        <i class="fas fa-file-import"></i> Import
                    </button>
                </div>
            </div>
            
            <div style="margin:15px 0; padding:15px; background:#1a1a1a; border-radius:8px;">
                <label style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="autoNumber" checked>
                    Auto-number questions
                </label>
                <label style="display:flex; align-items:center; gap:10px; margin-top:10px;">
                    <input type="checkbox" id="showOptions" checked>
                    Show options grid
                </label>
            </div>
        </div>
        
        <!-- Questions Container -->
        <div id="questionsContainer"></div>
        
        <!-- Action Buttons -->
        <div class="btn-group" style="justify-content:center; margin:30px 0;">
            <button class="btn btn-primary" onclick="previewQuiz()">
                <i class="fas fa-eye"></i> Preview
            </button>
            <button class="btn btn-success" onclick="saveQuiz()">
                <i class="fas fa-save"></i> Save Quiz
            </button>
            <button class="btn btn-warning" onclick="generate()">
                <i class="fas fa-file-export"></i> Generate Output
            </button>
            <button class="btn btn-secondary" onclick="printQuiz()">
                <i class="fas fa-print"></i> Print
            </button>
        </div>
        
        <!-- Output Preview -->
        <div id="output" style="display:none;">
            <div class="output-container">
                <div class="output-actions">
                    <button class="action-btn" onclick="copyOutput()" title="Copy HTML">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="action-btn" onclick="downloadOutput()" title="Download as HTML">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
                <div id="outputContent"></div>
            </div>
            
            <div class="btn-group" style="justify-content:center; margin:20px 0;">
                <button class="btn btn-primary" onclick="saveImage()">
                    <i class="fas fa-image"></i> Save as Image
                </button>
                <button class="btn btn-secondary" onclick="savePDF()">
                    <i class="fas fa-file-pdf"></i> Save as PDF
                </button>
                <button class="btn btn-secondary" onclick="shareQuiz()">
                    <i class="fas fa-share-alt"></i> Share
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>
    
    <!-- Templates Modal -->
    <div id="templatesModal" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-layer-group"></i> Quiz Templates</h3>
            <div id="templatesList"></div>
            <div class="btn-group" style="margin-top:20px;">
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-file-import"></i> Import Questions</h3>
            <textarea id="importText" placeholder="Paste questions here in format:
1. Question text
A) Option A
B) Option B
C) Option C
D) Option D
E) Option E
Correct: A" style="height:300px;"></textarea>
            <div class="btn-group" style="margin-top:20px;">
                <button class="btn btn-primary" onclick="parseImportedQuestions()">Import</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize
let currentQuiz = null;
let autoSaveTimer = null;
let recentQuizzes = JSON.parse(localStorage.getItem('recentQuizzes') || '[]');

// Toast notification
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.background = type === 'error' ? 'var(--primary)' : 'var(--success)';
    toast.style.display = 'block';
    
    setTimeout(() => {
        toast.style.display = 'none';
    }, 3000);
}

// Populate days
for(let i = 1; i <= 31; i++) {
    let d = i < 10 ? "0" + i : i;
    day.innerHTML += `<option>${d}</option>`;
}

// Initialize home stats
function updateHomeStats() {
    const statsContainer = document.getElementById('homeStats');
    const allQuizzes = Object.keys(localStorage).filter(k => k.startsWith('quiz_'));
    
    let totalQuestions = 0;
    allQuizzes.forEach(key => {
        const quiz = JSON.parse(localStorage.getItem(key));
        totalQuestions += quiz.questions.length;
    });
    
    statsContainer.innerHTML = `
        <div class="stat-card">
            <div class="stat-number">${allQuizzes.length}</div>
            <div class="stat-label">Total Quizzes</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${totalQuestions}</div>
            <div class="stat-label">Total Questions</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${recentQuizzes.length}</div>
            <div class="stat-label">Recently Viewed</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${new Set(allQuizzes.map(k => k.split('_')[1])).size}</div>
            <div class="stat-label">Subjects</div>
        </div>
    `;
}

// Toggle other fields
function toggleOtherSubject() {
    otherSubject.style.display = subjectSelect.value === "other" ? "block" : "none";
}

function toggleOtherGroup() {
    otherGroup.style.display = groupSelect.value === "other" ? "block" : "none";
}

// Navigation
function newQuiz() {
    homeScreen.style.display = "none";
    mainUI.style.display = "block";
    updateCompletion();
}

function goHome() {
    homeScreen.style.display = "block";
    mainUI.style.display = "none";
    updateHomeStats();
}

// Auto-save functionality
function startAutoSave() {
    if (autoSaveTimer) clearInterval(autoSaveTimer);
    autoSaveTimer = setInterval(autoSave, 30000); // Auto-save every 30 seconds
}

function autoSave() {
    if (!sheetName.value) return;
    saveQuiz(true);
}

// Update completion percentage
function updateCompletion() {
    const totalFields = 5; // sheet name, subject, group, date, at least 1 question
    let completed = 0;
    
    if (sheetName.value) completed++;
    if (subjectSelect.value) completed++;
    if (groupSelect.value) completed++;
    if (year.value && month.value && day.value) completed++;
    if (document.querySelectorAll('.questionBox').length > 0) completed++;
    
    const percent = Math.round((completed / totalFields) * 100);
    document.getElementById('completionPercent').textContent = percent + '%';
    document.getElementById('completionBar').style.width = percent + '%';
}

// Create questions
function createQuestions() {
    let count = parseInt(questionCount.value);
    if (!count || count < 1) return;
    
    questionsContainer.innerHTML = "";
    
    for (let i = 1; i <= count; i++) {
        createQuestionElement(i);
    }
    
    updateCompletion();
    startAutoSave();
}

function createQuestionElement(number) {
    let div = document.createElement("div");
    div.className = "question-card";
    div.dataset.number = number;
    
    div.innerHTML = `
        <div class="question-header">
            <div class="question-number">Question ${number}</div>
            <div class="question-actions">
                <button class="action-btn" onclick="moveQuestionUp(this)" title="Move Up">
                    <i class="fas fa-arrow-up"></i>
                </button>
                <button class="action-btn" onclick="moveQuestionDown(this)" title="Move Down">
                    <i class="fas fa-arrow-down"></i>
                </button>
                <button class="action-btn" onclick="duplicateQuestion(this)" title="Duplicate">
                    <i class="fas fa-copy"></i>
                </button>
                <button class="action-btn" onclick="deleteQuestion(this)" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        
        <textarea class="qText" placeholder="Enter question text..."
                  oninput="updateQuestionPreview(this)"></textarea>
        
        <div style="margin:15px 0;">
            <label style="display:block; margin-bottom:8px;">Options:</label>
            <div class="options-grid">
                <div class="option-item" data-option="A">
                    <input type="radio" name="correct${number}" value="A" onchange="markCorrectOption(this)">
                    <span style="font-weight:bold; color:#ff6b6b;">A)</span>
                    <input type="text" class="optionText" placeholder="Option A" style="flex:1;">
                </div>
                <div class="option-item" data-option="B">
                    <input type="radio" name="correct${number}" value="B" onchange="markCorrectOption(this)">
                    <span style="font-weight:bold; color:#4ecdc4;">B)</span>
                    <input type="text" class="optionText" placeholder="Option B" style="flex:1;">
                </div>
                <div class="option-item" data-option="C">
                    <input type="radio" name="correct${number}" value="C" onchange="markCorrectOption(this)">
                    <span style="font-weight:bold; color:#ffe66d;">C)</span>
                    <input type="text" class="optionText" placeholder="Option C" style="flex:1;">
                </div>
                <div class="option-item" data-option="D">
                    <input type="radio" name="correct${number}" value="D" onchange="markCorrectOption(this)">
                    <span style="font-weight:bold; color:#95e1d3;">D)</span>
                    <input type="text" class="optionText" placeholder="Option D" style="flex:1;">
                </div>
                <div class="option-item" data-option="E">
                    <input type="radio" name="correct${number}" value="E" onchange="markCorrectOption(this)">
                    <span style="font-weight:bold; color:#ffaaa5;">E)</span>
                    <input type="text" class="optionText" placeholder="Option E" style="flex:1;">
                </div>
            </div>
        </div>
        
        <div style="margin-top:15px; padding-top:15px; border-top:1px solid var(--border);">
            <label>Explanation (optional):</label>
            <textarea class="explanation" placeholder="Add explanation for the correct answer..." 
                      style="height:60px; margin-top:5px;"></textarea>
        </div>
    `;
    
    questionsContainer.appendChild(div);
}

function markCorrectOption(radio) {
    const optionItem = radio.closest('.option-item');
    document.querySelectorAll('.option-item').forEach(item => {
        item.classList.remove('correct');
    });
    optionItem.classList.add('correct');
}

function addSingleQuestion() {
    const count = document.querySelectorAll('.question-card').length;
    createQuestionElement(count + 1);
    questionCount.value = count + 1;
    updateCompletion();
}

// Question manipulation
function moveQuestionUp(btn) {
    const card = btn.closest('.question-card');
    const prev = card.previousElementSibling;
    if (prev) {
        card.parentNode.insertBefore(card, prev);
        renumberQuestions();
    }
}

function moveQuestionDown(btn) {
    const card = btn.closest('.question-card');
    const next = card.nextElementSibling;
    if (next) {
        card.parentNode.insertBefore(next, card);
        renumberQuestions();
    }
}

function duplicateQuestion(btn) {
    const card = btn.closest('.question-card');
    const newCard = card.cloneNode(true);
    newCard.dataset.number = parseInt(card.dataset.number) + 1;
    card.parentNode.insertBefore(newCard, card.nextSibling);
    renumberQuestions();
}

function duplicateLastQuestion() {
    const cards = document.querySelectorAll('.question-card');
    if (cards.length === 0) return;
    duplicateQuestion(cards[cards.length - 1].querySelector('.action-btn'));
}

function deleteQuestion(btn) {
    if (confirm('Delete this question?')) {
        const card = btn.closest('.question-card');
        card.remove();
        renumberQuestions();
        updateCompletion();
    }
}

function clearAllQuestions() {
    if (confirm('Clear all questions?')) {
        questionsContainer.innerHTML = "";
        questionCount.value = "";
        updateCompletion();
    }
}

function renumberQuestions() {
    document.querySelectorAll('.question-card').forEach((card, index) => {
        card.dataset.number = index + 1;
        card.querySelector('.question-number').textContent = `Question ${index + 1}`;
    });
}

// Randomize answers
function randomizeAnswers() {
    document.querySelectorAll('.question-card').forEach(card => {
        const options = ['A', 'B', 'C', 'D', 'E'];
        const randomOption = options[Math.floor(Math.random() * options.length)];
        const radio = card.querySelector(`input[value="${randomOption}"]`);
        if (radio) {
            radio.checked = true;
            markCorrectOption(radio);
        }
    });
    showToast('Answers randomized!');
}

// Validate quiz
function validateQuiz() {
    let errors = [];
    
    if (!sheetName.value) errors.push('Sheet name is required');
    if (!subjectSelect.value) errors.push('Subject is required');
    
    document.querySelectorAll('.question-card').forEach((card, index) => {
        const questionText = card.querySelector('.qText').value.trim();
        const hasCorrect = card.querySelector('input[type="radio"]:checked');
        const options = card.querySelectorAll('.optionText');
        let emptyOptions = 0;
        
        options.forEach(opt => {
            if (!opt.value.trim()) emptyOptions++;
        });
        
        if (!questionText) errors.push(`Question ${index + 1} has no text`);
        if (!hasCorrect) errors.push(`Question ${index + 1} has no correct answer`);
        if (emptyOptions > 2) errors.push(`Question ${index + 1} has too many empty options`);
    });
    
    if (errors.length === 0) {
        showToast('Quiz is valid! Ready to save.');
    } else {
        alert('Validation Errors:\n\n' + errors.join('\n'));
    }
}

// Save quiz
function saveQuiz(silent = false) {
    if (!sheetName.value) {
        if (!silent) showToast('Please enter a sheet name!', 'error');
        return;
    }
    
    let subject = subjectSelect.value === "other" ? otherSubject.value : subjectSelect.value;
    let group = groupSelect.value === "other" ? otherGroup.value : groupSelect.value;
    
    let key = "quiz_" + subject + "_" + sheetName.value;
    
    let data = {
        sheetName: sheetName.value,
        subject: subject,
        group: group,
        year: year.value,
        month: month.value,
        day: day.value,
        createdAt: new Date().toISOString(),
        modifiedAt: new Date().toISOString(),
        questions: []
    };
    
    document.querySelectorAll(".question-card").forEach(card => {
        const questionText = card.querySelector('.qText').value;
        const correctAnswer = card.querySelector('input[type="radio"]:checked')?.value || '';
        const explanation = card.querySelector('.explanation').value;
        const options = {};
        
        card.querySelectorAll('.option-item').forEach(item => {
            const option = item.dataset.option;
            const text = item.querySelector('.optionText').value;
            options[option] = text;
        });
        
        data.questions.push({
            text: questionText,
            answer: correctAnswer,
            explanation: explanation,
            options: options
        });
    });
    
    localStorage.setItem(key, JSON.stringify(data));
    
    // Add to recent quizzes
    const recentIndex = recentQuizzes.findIndex(q => q.key === key);
    if (recentIndex !== -1) {
        recentQuizzes.splice(recentIndex, 1);
    }
    recentQuizzes.unshift({
        key: key,
        name: sheetName.value,
        subject: subject,
        date: new Date().toLocaleDateString()
    });
    
    if (recentQuizzes.length > 10) {
        recentQuizzes = recentQuizzes.slice(0, 10);
    }
    
    localStorage.setItem('recentQuizzes', JSON.stringify(recentQuizzes));
    
    if (!silent) {
        showToast('Quiz saved successfully!');
        document.getElementById('saveStatus').innerHTML = '<i class="fas fa-check"></i> Saved';
        setTimeout(() => {
            document.getElementById('saveStatus').innerHTML = '<i class="fas fa-save"></i> Save';
        }, 2000);
    }
    
    updateHomeStats();
}

// Load quiz system
const subjects = [
    "Oral histology", "Microbiology", "Removeable prosthodontic",
    "Pathology", "Fixed prosthodontic", "Conservative", "Pharmacology"
];

function showLoadMenu() {
    loadMenu.style.display = "block";
    populateSubjectSelect();
    updateQuizList();
    
    const recentList = document.getElementById('recentList');
    if (recentQuizzes.length > 0) {
        recentList.innerHTML = recentQuizzes.map(quiz => `
            <div style="padding:10px; border:1px solid var(--border); margin:5px 0; border-radius:6px; cursor:pointer;" 
                 onclick="loadQuizByKey('${quiz.key}')">
                <strong>${quiz.name}</strong> - ${quiz.subject}<br>
                <small>${quiz.date}</small>
            </div>
        `).join('');
        document.getElementById('recentQuizzes').style.display = 'block';
    }
}

function populateSubjectSelect() {
    loadSubject.innerHTML = '<option value="">All Subjects</option>';
    subjects.forEach(s => {
        let opt = document.createElement("option");
        opt.textContent = s;
        loadSubject.appendChild(opt);
    });
}

function updateQuizList() {
    const searchTerm = document.getElementById('searchQuiz')?.value.toLowerCase() || '';
    const subjectFilter = loadSubject.value;
    
    const allKeys = Object.keys(localStorage).filter(k => k.startsWith('quiz_'));
    const quizList = document.getElementById('quizList');
    
    quizList.innerHTML = '';
    
    allKeys.forEach(k => {
        try {
            const data = JSON.parse(localStorage.getItem(k));
            
            // Apply filters
            if (subjectFilter && !k.includes(subjectFilter)) return;
            if (searchTerm && !data.sheetName.toLowerCase().includes(searchTerm)) return;
            
            const div = document.createElement('div');
            div.className = 'quiz-list-item';
            div.style.cssText = `
                padding:12px; border:1px solid var(--border); 
                margin:8px 0; border-radius:8px; cursor:pointer;
                background: var(--card-bg); transition: all 0.3s;
            `;
            div.onmouseover = () => div.style.borderColor = 'var(--primary)';
            div.onmouseout = () => div.style.borderColor = 'var(--border)';
            div.onclick = () => {
                document.querySelectorAll('.quiz-list-item').forEach(i => {
                    i.style.background = 'var(--card-bg)';
                });
                div.style.background = 'rgba(196, 0, 0, 0.1)';
                loadSheet.value = data.sheetName;
            };
            
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:start;">
                    <div>
                        <strong style="color:var(--primary);">${data.sheetName}</strong><br>
                        <small>${data.subject} • ${data.group}</small><br>
                        <small>${data.questions.length} questions • ${data.modifiedAt ? new Date(data.modifiedAt).toLocaleDateString() : ''}</small>
                    </div>
                    <div style="text-align:right;">
                        <small style="color:var(--text-secondary);">${data.year}-${data.month}-${data.day}</small>
                    </div>
                </div>
            `;
            
            quizList.appendChild(div);
        } catch(e) {
            console.error('Error loading quiz:', e);
        }
    });
}

function filterQuizzes() {
    updateQuizList();
}

function loadSelectedQuiz() {
    const subject = loadSubject.value || '';
    const name = loadSheet.value;
    
    if (!name) {
        showToast('Please select a quiz!', 'error');
        return;
    }
    
    const key = subject ? `quiz_${subject}_${name}` : 
        Object.keys(localStorage).find(k => k.endsWith(`_${name}`));
    
    if (key) {
        loadQuizByKey(key);
    } else {
        showToast('Quiz not found!', 'error');
    }
}

function loadQuizByKey(key) {
    const raw = localStorage.getItem(key);
    if (!raw) return;
    
    const data = JSON.parse(raw);
    currentQuiz = { key, data };
    
    // Switch to editor
    newQuiz();
    
    // Populate fields
    sheetName.value = data.sheetName;
    subjectSelect.value = data.subject;
    groupSelect.value = data.group;
    year.value = data.year;
    month.value = data.month;
    day.value = data.day;
    
    // Clear and create questions
    questionsContainer.innerHTML = "";
    questionCount.value = data.questions.length;
    
    data.questions.forEach((q, index) => {
        createQuestionElement(index + 1);
        const card = document.querySelectorAll('.question-card')[index];
        
        // Set question text
        card.querySelector('.qText').value = q.text;
        
        // Set options
        if (q.options) {
            Object.entries(q.options).forEach(([option, text]) => {
                const input = card.querySelector(`.option-item[data-option="${option}"] .optionText`);
                if (input) input.value = text;
            });
        }
        
        // Set correct answer
        if (q.answer) {
            const radio = card.querySelector(`input[value="${q.answer}"]`);
            if (radio) {
                radio.checked = true;
                markCorrectOption(radio);
            }
        }
        
        // Set explanation
        if (q.explanation) {
            card.querySelector('.explanation').value = q.explanation;
        }
    });
    
    showToast('Quiz loaded successfully!');
    updateCompletion();
}

function deleteSelectedQuiz() {
    const name = loadSheet.value;
    if (!name) return;
    
    if (confirm(`Delete quiz "${name}"?`)) {
        const subject = loadSubject.value || '';
        const key = subject ? `quiz_${subject}_${name}` : 
            Object.keys(localStorage).find(k => k.endsWith(`_${name}`));
        
        if (key) {
            localStorage.removeItem(key);
            updateQuizList();
            showToast('Quiz deleted!');
        }
    }
}

function exportSelectedQuiz() {
    const name = loadSheet.value;
    if (!name) return;
    
    const subject = loadSubject.value || '';
    const key = subject ? `quiz_${subject}_${name}` : 
        Object.keys(localStorage).find(k => k.endsWith(`_${name}`));
    
    if (key) {
        const data = localStorage.getItem(key);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${name}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Quiz exported!');
    }
}

// Templates
function showTemplates() {
    const modal = document.getElementById('templatesModal');
    const list = document.getElementById('templatesList');
    
    const templates = [
        { name: 'MCQ Template', questions: 10, subject: 'General' },
        { name: 'Quick Quiz', questions: 5, subject: 'General' },
        { name: 'Exam Practice', questions: 25, subject: 'General' },
        { name: 'Review Test', questions: 15, subject: 'General' }
    ];
    
    list.innerHTML = templates.map(t => `
        <div style="padding:15px; border:1px solid var(--border); margin:10px 0; border-radius:8px; cursor:pointer;"
             onclick="loadTemplate(${t.questions})">
            <strong>${t.name}</strong><br>
            <small>${t.questions} questions • ${t.subject}</small>
        </div>
    `).join('');
    
    modal.style.display = 'flex';
}

function loadTemplate(questionCount) {
    closeModal();
    newQuiz();
    questionCount.value = questionCount;
    createQuestions();
    
    // Set some default values
    sheetName.value = `Template ${questionCount} Questions`;
    showToast(`Template loaded with ${questionCount} questions`);
}

function closeModal() {
    document.querySelectorAll('.modal').forEach(m => {
        m.style.display = 'none';
    });
}

// Import questions
function importQuestions() {
    const modal = document.getElementById('importModal');
    modal.style.display = 'flex';
}

function parseImportedQuestions() {
    const text = document.getElementById('importText').value;
    const lines = text.split('\n');
    let currentQuestion = null;
    const questions = [];
    
    lines.forEach(line => {
        line = line.trim();
        if (!line) return;
        
        // Check if it's a question number
        if (/^\d+[\.\)]/.test(line)) {
            if (currentQuestion) questions.push(currentQuestion);
            currentQuestion = {
                text: line.replace(/^\d+[\.\)]\s*/, ''),
                options: {},
                answer: ''
            };
        }
        // Check if it's an option
        else if (/^[A-E][\.\)]/.test(line)) {
            if (currentQuestion) {
                const option = line[0];
                const optionText = line.substring(2).trim();
                currentQuestion.options[option] = optionText;
            }
        }
        // Check for correct answer
        else if (/^correct:\s*[A-E]/i.test(line)) {
            if (currentQuestion) {
                currentQuestion.answer = line.match(/[A-E]/i)[0].toUpperCase();
            }
        }
        // Append to question text
        else if (currentQuestion && !currentQuestion.text.includes(line)) {
            currentQuestion.text += '\n' + line;
        }
    });
    
    if (currentQuestion) questions.push(currentQuestion);
    
    // Add imported questions
    questions.forEach((q, index) => {
        if (index === 0) {
            // First question, replace current ones
            questionCount.value = questions.length;
            createQuestions();
        }
        
        const card = document.querySelectorAll('.question-card')[index];
        if (card) {
            card.querySelector('.qText').value = q.text;
            
            Object.entries(q.options).forEach(([option, text]) => {
                const input = card.querySelector(`.option-item[data-option="${option}"] .optionText`);
                if (input) input.value = text;
            });
            
            if (q.answer) {
                const radio = card.querySelector(`input[value="${q.answer}"]`);
                if (radio) {
                    radio.checked = true;
                    markCorrectOption(radio);
                }
            }
        }
    });
    
    closeModal();
    showToast(`Imported ${questions.length} questions`);
}

// Generate output
function generate() {
    if (!document.querySelectorAll('.question-card').length) {
        showToast('Please add questions first!', 'error');
        return;
    }
    
    let subject = subjectSelect.value === "other" ? otherSubject.value : subjectSelect.value;
    let group = groupSelect.value === "other" ? otherGroup.value : groupSelect.value;
    
    let html = `
        <div class="preview-header">
            <div style="font-size:32px; font-weight:bold; color:var(--primary);">${subject}</div>
            ${sheetName.value ? `<div style="display:inline-block; margin-top:10px; padding:6px 15px; font-size:16px; color:#ff3b3b; background:#1a1a1a; border:2px solid #ff3b3b; border-radius:8px; font-weight:600;">${sheetName.value}</div>` : ""}
            <div style="display:flex; justify-content:center; gap:15px; margin-top:15px; flex-wrap:wrap;">
                <div style="background:#101010; border:1px solid #2d2d2d; border-radius:8px; padding:8px 16px;">
                    Group: ${group}
                </div>
                <div style="background:#101010; border:1px solid #2d2d2d; border-radius:8px; padding:8px 16px;">
                    Date: ${year.value}-${month.value}-${day.value}
                </div>
            </div>
        </div>
    `;
    
    document.querySelectorAll(".question-card").forEach((card, index) => {
        const questionText = card.querySelector('.qText').value;
        const correctAnswer = card.querySelector('input[type="radio"]:checked')?.value || '';
        const explanation = card.querySelector('.explanation').value;
        
        html += `<div style="margin-bottom:30px; padding-bottom:20px; border-bottom:2px solid #2a2a2a;">`;
        html += `<div style="font-weight:bold; color:var(--primary); margin-bottom:10px;">Question ${index + 1}</div>`;
        
        // Split question text into lines
        const lines = questionText.split('\n');
        lines.forEach(l => {
            l = l.trim();
            if (!l) return;
            
            if (correctAnswer && /^[A-E][\.\)]/.test(l) && l[0].toUpperCase() === correctAnswer)
                html += `<div style="color:#ff0000; font-weight:bold; margin:5px 0; padding:5px; background:rgba(255,0,0,0.1); border-radius:4px;">${l}</div>`;
            else
                html += `<div style="color:#cfcfcf; margin:5px 0;">${l}</div>`;
        });
        
        // Add explanation if exists
        if (explanation) {
            html += `<div style="margin-top:10px; padding:10px; background:rgba(0,168,107,0.1); border-left:4px solid var(--success); border-radius:4px;">
                <strong>Explanation:</strong> ${explanation}
            </div>`;
        }
        
        html += `</div>`;
    });
    
    html += `<div style="margin-top:40px; text-align:right; font-size:14px; color:#666; border-top:1px solid #333; padding-top:10px;">
        Generated by Quiz Generator Pro • @Idkwjwnn
    </div>`;
    
    document.getElementById('outputContent').innerHTML = html;
    document.getElementById('output').style.display = 'block';
    showToast('Output generated successfully!');
    
    // Scroll to output
    document.getElementById('output').scrollIntoView({ behavior: 'smooth' });
}

// Preview function
function previewQuiz() {
    generate();
}

// Copy output
function copyOutput() {
    const content = document.getElementById('outputContent').innerHTML;
    navigator.clipboard.writeText(content).then(() => {
        showToast('HTML copied to clipboard!');
    });
}

// Download output
function downloadOutput() {
    const content = document.getElementById('outputContent').innerHTML;
    const fullHtml = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <style>
                body { background:#0b0b0b; color:white; font-family:Arial; padding:40px; max-width:800px; margin:0 auto; }
                .question { margin-bottom:30px; padding-bottom:20px; border-bottom:2px solid #2a2a2a; }
                .answer { color:#ff0000; font-weight:bold; }
            </style>
        </head>
        <body>
            ${content}
        </body>
        </html>
    `;
    
    const blob = new Blob([fullHtml], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${sheetName.value || 'quiz'}.html`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('HTML file downloaded!');
}

// Save as Image (improved)
async function saveImage() {
    if (!document.getElementById('outputContent').innerHTML) {
        showToast('Please generate the quiz first!', 'error');
        return;
    }
    
    try {
        const saveBtn = document.querySelector('button[onclick="saveImage()"]');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        saveBtn.disabled = true;
        
        // Create temporary container
        const tempDiv = document.createElement('div');
        tempDiv.style.position = 'fixed';
        tempDiv.style.left = '-9999px';
        tempDiv.style.top = '0';
        tempDiv.style.width = '800px';
        tempDiv.style.background = '#0b0b0b';
        tempDiv.style.padding = '40px';
        tempDiv.style.color = 'white';
        tempDiv.style.fontFamily = 'Arial, sans-serif';
        tempDiv.innerHTML = document.getElementById('outputContent').innerHTML;
        document.body.appendChild(tempDiv);
        
        // Wait for rendering
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Capture image
        const canvas = await html2canvas(tempDiv, {
            backgroundColor: '#0b0b0b',
            scale: 2,
            useCORS: true,
            logging: false
        });
        
        // Clean up
        document.body.removeChild(tempDiv);
        
        // Create download link
        const link = document.createElement('a');
        const fileName = `${sheetName.value || 'quiz'}_${new Date().getTime()}.png`;
        link.download = fileName;
        link.href = canvas.toDataURL('image/png');
        
        // Trigger download
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('Image saved successfully!');
        
    } catch (error) {
        console.error('Error saving image:', error);
        showToast('Error saving image!', 'error');
    } finally {
        const saveBtn = document.querySelector('button[onclick="saveImage()"]');
        saveBtn.innerHTML = '<i class="fas fa-image"></i> Save as Image';
        saveBtn.disabled = false;
    }
}

// PDF function (placeholder - would need jsPDF library)
function savePDF() {
    showToast('PDF export requires jsPDF library. Consider adding it!', 'warning');
}

// Share function
function shareQuiz() {
    if (navigator.share) {
        navigator.share({
            title: sheetName.value || 'Quiz',
            text: `Check out this quiz: ${subjectSelect.value}`,
            url: window.location.href
        });
    } else {
        navigator.clipboard.writeText(window.location.href).then(() => {
            showToast('Link copied to clipboard!');
        });
    }
}

// Print function
function printQuiz() {
    const printContent = document.getElementById('outputContent').innerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Print Quiz</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                @media print {
                    body { padding: 0; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="no-print" style="margin-bottom:20px;">
                <button onclick="window.print()">Print</button>
                <button onclick="window.close()">Close</button>
            </div>
            ${printContent}
        </body>
        </html>
    `);
    printWindow.document.close();
}

// Stats function
function showStats() {
    alert(`Quiz Statistics:
    • Total Quizzes: ${Object.keys(localStorage).filter(k => k.startsWith('quiz_')).length}
    • Recent Quizzes: ${recentQuizzes.length}
    • Storage Used: ${Math.round((JSON.stringify(localStorage).length / 1024) * 100) / 100} KB
    
    Tip: You can export your quizzes as JSON for backup!`);
}

// Initialize on load
window.addEventListener('load', () => {
    updateHomeStats();
    
    // Add input listeners for auto-save
    document.querySelectorAll('input, select, textarea').forEach(input => {
        input.addEventListener('input', updateCompletion);
        input.addEventListener('change', updateCompletion);
    });
    
    // Auto-save on beforeunload
    window.addEventListener('beforeunload', () => {
        if (sheetName.value) autoSave();
    });
});

// Close modals on ESC
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
});
</script>
</body>
</html>
